<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Hex Dots</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">
    // Game data
    const numRows = 6;
    const numCols = 7;
    const numColors = 4;

    // Grid view data
    // Row number x column number array of x, y positions
    var grid_positions = [];

    // Row number x column number array of dots
    var dots;

    // Connecting dots
    // State of the scene
    const State = Object.freeze({ 
        IDLE: 0,
        CONNECT: 1,
        REPOSITION: 3
    });
    var state = State.IDLE;

    // List of currently connected dots while cursor is down
    var connected_dots = [];

    class DotsScene extends Phaser.Scene
    {
        constructor ()
        {
            super();
        }

        preload ()
        {
        }

        create ()
        {
            this.drawHexTiles();
            // spawnDot(this, 300, 400)
            this.initializeDots();
            console.log("Dots : " + dots);

            for (var i = 0; i < numRows; i++) {
                for (var j = 0; j < numCols; j++) {
                    console.log("Color on initialize : " + i + " " + j + " " + dots[i][j].getData('color'));
                }
            }

            this.handleInputEvents()
        }

        update ()
        {
        }

        handleInputEvents()
        {
            this.input.on('pointerup', pointer =>
            {
                if (pointer.leftButtonReleased()) {
                    onLeftClickReleased();
                }
            });

            this.input.on('gameobjectdown', function (pointer, gameObject)
            {
                gameObject.emit('clicked', gameObject);
            }, this);

            this.input.on('gameobjectover', function (pointer, gameObject)
            {
                gameObject.emit('hover', gameObject);
            }, this);
        }

         // Initialize dots
        initializeDots()
        {
            dots = [];
            for (var i = 0; i < numRows; i++) {
                dots[i] = [];

                for (var j = 0; j < numCols; j++) {
                    var dot = this.spawnDot(grid_positions[i][j].x, grid_positions[i][j].y, this.getRandomDotColor());
                    console.log("Color on creation : " +dot.getData('color'));
                    dots[i][j] = dot;
                }
            }
        }

        spawnDot(x, y, color) 
        {
            const dotSize = 20
            var dot = new Phaser.GameObjects.Ellipse(this, x, y, dotSize, dotSize, color);
            dot.setData('color', color)
            console.log("Color: " + dot.getData('color'))
            

            dot.setInteractive();
            dot.on('clicked', this.onDotClick, this);
            dot.on('hover', this.onDotHover, this);

            this.add.existing(dot);
            return dot;
        }

        onDotClick(dot)
        {
            if (state === State.IDLE) {
                connected_dots.push(dot)
                state = State.CONNECT;
                console.log("State: " + state)
                console.log("Click Color: " + dot.getData('color'))
                console.log("Dots: " + connected_dots)
            }
        }
        
        onDotHover(dot)
        {
            console.log("Dot hover color: " + dot.getData('color'))
            if (state === State.CONNECT) {
                // If color matches the line of connected dots, add to the line
                if(dot.getData('color') === connected_dots[0].getData('color')) {
                    connected_dots.push(dot)
                    
                    console.log("Color 0: " + connected_dots[0].getData('color'))
                    console.log("Dots: " + connected_dots)
                }
            }
        }

        onLeftClickReleased() 
        {
            if (state === State.CONNECT) {
                connected_dots = [];
                state = State.IDLE;
                console.log("State: " + state)
            }
        }

        getRandomDotColor()
        {    
            const colorList = [
                0xf46d43,
                0xd8e594,
                0x3288bd,
                0x66c2a5,
                0xfdae61,
                0xd53e4f,
                0xfee08b,
                0xabdda4
            ]

            // Random integer within interval [0, numColors)
            var randomIndex = Math.floor(Math.random() * numColors);
            return colorList[randomIndex];
        }

        // Grid view functions
        // Create hex tiles with code
        drawHexTiles()
        {
            const xOffset = 100
            const yOffset = 100
            const hexSize = 50;

            const hexHeight = Math.sqrt(3) * hexSize / 2;

            for (var i = 0; i < numRows; i++) {
                grid_positions[i] = []
                var oddRow = (i % 2 != 0)

                for (var j = 0; j < numCols; j++) {
                    var x = j * 2 * hexHeight;
                    if (oddRow)
                        x += hexHeight;

                    var y = i * (1.5 * hexSize);

                    x += xOffset
                    y += yOffset
                    
                    grid_positions[i][j] = {x : x, y : y}
                    this.drawHexagon(x, y, hexSize);
                }
            }

        }

        drawHexagon(x, y, size) 
        {
            var graphics = this.add.graphics();
            graphics.lineStyle(2, 0x111111, 1);

            var points = [];
            for (var i = 0; i < 6; i++) {
                var angle = Phaser.Math.DegToRad(60 * i + 30);
                points.push(new Phaser.Geom.Point(x + size * Math.cos(angle), y + size * Math.sin(angle)));
            }

            graphics.beginPath();
            graphics.moveTo(points[0].x, points[0].y);

            for (var i = 1; i < 6; i++) {
                graphics.lineTo(points[i].x, points[i].y);
            }

            graphics.closePath();
            graphics.strokePath();
        }
    }

    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        backgroundColor: '#eeeeee',
        scene: DotsScene
    };

    var game = new Phaser.Game(config);
    
</script>

</body>
</html>